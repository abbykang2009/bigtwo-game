<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Two - 2-3 Player Online</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f0f0; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .game-area { display: none; }
        .card { width: 60px; height: 90px; background-color: white; border: 1px solid #ccc; border-radius: 5px; display: inline-block; margin: 5px; text-align: center; line-height: 90px; font-size: 16px; cursor: pointer; position: relative; box-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
        .card.selected { transform: translateY(-20px); box-shadow: 0 5px 10px rgba(0,0,0,0.2); }
        .card.hearts, .card.diamonds { color: red; }
        .card.spades, .card.clubs { color: black; }
        .card .rank { position: absolute; top: 5px; left: 5px; font-size: 14px; }
        .card .suit { font-size: 24px; }
        .card .rank.bottom { top: auto; left: auto; bottom: 5px; right: 5px; }
        .player-hand { margin-top: 20px; min-height: 120px; border-top: 2px solid #ddd; padding-top: 20px; }
        .opponent-info { margin-bottom: 20px; padding: 10px; background-color: #f9f9f9; border-radius: 5px; display: inline-block; width: 30%; margin-right: 2%; }
        .game-info { margin-bottom: 20px; padding: 10px; background-color: #e9f7ef; border-radius: 5px; }
        .last-played { margin: 20px 0; min-height: 100px; border: 1px dashed #ccc; border-radius: 5px; padding: 10px; }
        button { padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        button:disabled { background-color: #cccccc; }
        button:hover:not(:disabled) { background-color: #45a049; }
        .lobby { margin-bottom: 20px; }
        .room-info { font-weight: bold; margin: 10px 0; }
        .winner-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .winner-content { background-color: white; padding: 30px; border-radius: 10px; text-align: center; }
        .player-count { margin: 10px 0; font-style: italic; }
    </style>
</head>
<body>
     <!-- Your game HTML here -->

    <!-- 2. Initialize socket BEFORE your game logic -->
    <script>
        // Initialize Socket.IO connection
        const socket = io("https://bigtwo-game.onrender.com", {
            reconnection: true,
            reconnectionAttempts: 5
        });

        // Debugging connection
        socket.on('connect', () => console.log("Connected! Socket ID:", socket.id));
        socket.on('disconnect', () => console.log("Disconnected!"));

        // --- YOUR EXISTING GAME CODE BELOW HERE ---
        let playerId;
        let roomId;
        
        function createGame() {
            // ... your existing functions ...
        }
    </script>
    <div class="container">
        <h1>Big Two - 2-3 Player Online</h1>
        
        <div id="setup-area">
            <div id="create-game" class="lobby">
                <h2>Create Game</h2>
                <input type="text" id="player-name-create" placeholder="Your Name">
                <button onclick="createGame()">Create Game</button>
            </div>
            
            <div id="join-game" class="lobby">
                <h2>Join Game</h2>
                <input type="text" id="player-name-join" placeholder="Your Name">
                <input type="text" id="room-id" placeholder="Room ID">
                <button onclick="joinGame()">Join Game</button>
            </div>
        </div>
        
        <div id="waiting-area" style="display: none;">
            <h2>Waiting for players...</h2>
            <div class="room-info">Room ID: <span id="display-room-id"></span></div>
            <div class="player-count">(<span id="player-count">1</span>/3 players, minimum 2 to start)</div>
            <p>Share the Room ID with friends to join the game.</p>
            <div id="player-list"></div>
            <button id="ready-btn" onclick="ready()">Ready</button>
        </div>
        
        <div id="game-area" class="game-area">
            <div id="opponents-container" style="display: flex; justify-content: space-between;"></div>
            
            <div class="game-info">
                <p id="turn-indicator"></p>
            </div>
            
            <div class="last-played">
                <h3>Last Played:</h3>
                <div id="last-played-cards"></div>
            </div>
            
            <div class="player-hand">
                <h3>Your Hand:</h3>
                <div id="hand"></div>
            </div>
            
            <div class="controls">
                <button id="play-btn" onclick="playCards()">Play Selected</button>
                <button id="pass-btn" onclick="passTurn()">Pass</button>
            </div>
        </div>
    </div>

    <div id="winner-screen" class="winner-screen">
        <div class="winner-content">
            <h2 id="winner-message"></h2>
            <div id="scores-display"></div>
            <button onclick="location.reload()">Play Again</button>
        </div>
    </div>

    <script>
        let socket;
        let playerId;
        let roomId;
        let selectedCards = [];
        
        function createGame() {
    const playerName = document.getElementById('player-name').value;
    
    fetch('/create_game', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ player_name: playerName })
    })
    .then(response => response.json())
    .then(data => {
        window.location.href = `/game?room=${data.room_id}&player=${data.player_id}`;
    })
    .catch(error => console.error('Error:', error));
}
        
        function joinGame() {
            const playerName = document.getElementById('player-name-join').value;
            const roomIdInput = document.getElementById('room-id').value;
            
            if (!playerName || !roomIdInput) {
                alert('Please enter your name and room ID');
                return;
            }
            
            fetch('/join_game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    player_name: playerName,
                    room_id: roomIdInput 
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                playerId = data.player_id;
                roomId = data.room_id;
                
                document.getElementById('setup-area').style.display = 'none';
                document.getElementById('waiting-area').style.display = 'block';
                document.getElementById('display-room-id').textContent = roomId;
                
                connectSocket();
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        function ready() {
            fetch('/ready', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('player-count').textContent = Object.keys(games[roomId].players).length;
                
                if (data.show_face_up_card) {
                    showFaceUpCard(data.face_up_card);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        function showFaceUpCard(card) {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';
            
            const content = document.createElement('div');
            content.style.backgroundColor = 'white';
            content.style.padding = '20px';
            content.style.borderRadius = '10px';
            content.style.textAlign = 'center';
            
            content.innerHTML = `
                <h2>Face Up Card</h2>
                <div id="face-up-card-display" style="margin: 20px;"></div>
                <p>The player with the 3♦ gets this card (or 3♣ if this is the 3♦)</p>
                <button onclick="startGameAfterShowingCard()">Continue</button>
            `;
            
            const cardElement = createCardElement(card, false);
            document.getElementById('face-up-card-display').appendChild(cardElement);
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        function startGameAfterShowingCard() {
            fetch('/start_game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.game_started) {
                    document.querySelector('div[style*="rgba(0,0,0,0.7)"]').remove();
                    document.getElementById('waiting-area').style.display = 'none';
                    document.getElementById('game-area').style.display = 'block';
                    updateGameState();
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        function connectSocket() {
    socket = io();
    
    socket.on('connect', () => {
        console.log('Connected to socket server');
        // Tell server we're joining the room
        socket.emit('join_room', { 
            room_id: roomId, 
            player_name: document.getElementById('player-name-create').value || 
                        document.getElementById('player-name-join').value 
        });
    });

    // Add these NEW EVENT HANDLERS:
    socket.on('room_update', (data) => {
        const playerList = document.getElementById('player-list');
        playerList.innerHTML = '';  // Clear current list
        
        data.players.forEach(player => {
            const li = document.createElement('li');
            li.textContent = player;
            playerList.appendChild(li);
        });
    });

    socket.on('error', (data) => {
        alert(data.message);
    });

    // Keep your existing game_update handler
    socket.on('game_update', (data) => {
        updateGameState();
        if (data.winner) {
            showWinnerScreen(data.winner, data.scores);
        }
    });
    
    socket.on('play_error', (data) => {
        alert(data.message);
    });
}
        
        function updatePlayerList() {
            fetch('/game_state')
            .then(response => response.json())
            .then(data => {
                if (!data.error && data.game_started === false) {
                    document.getElementById('player-count').textContent = 
                        Object.keys(games[roomId].players).length;
                }
            });
        }
        
        function updateGameState() {
            fetch('/game_state')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error(data.error);
                    return;
                }
                
                // Update opponents display
                const opponentsContainer = document.getElementById('opponents-container');
                opponentsContainer.innerHTML = '';
                
                data.opponents.forEach(opponent => {
                    const opponentDiv = document.createElement('div');
                    opponentDiv.className = 'opponent-info';
                    opponentDiv.innerHTML = `
                        <h3>${opponent.name}</h3>
                        <p>Cards: ${opponent.card_count}</p>
                        ${opponent.score ? `<p>Score: ${opponent.score}</p>` : ''}
                    `;
                    opponentsContainer.appendChild(opponentDiv);
                });
                
                // Update turn indicator
                const turnIndicator = document.getElementById('turn-indicator');
                if (data.is_current_player) {
                    turnIndicator.textContent = "It's your turn!";
                    turnIndicator.style.color = "green";
                } else {
                    turnIndicator.textContent = "Waiting for opponent...";
                    turnIndicator.style.color = "red";
                }
                
                // Update last played cards
                const lastPlayedDiv = document.getElementById('last-played-cards');
                lastPlayedDiv.innerHTML = '';
                if (data.last_played) {
                    data.last_played.forEach(card => {
                        lastPlayedDiv.appendChild(createCardElement(card, false));
                    });
                } else {
                    lastPlayedDiv.innerHTML = '<p>No cards played yet</p>';
                }
                
                // Update player's hand
                const handDiv = document.getElementById('hand');
                handDiv.innerHTML = '';
                data.hand.forEach(card => {
                    const cardElement = createCardElement(card, true);
                    handDiv.appendChild(cardElement);
                });
                
                // Enable/disable buttons
                document.getElementById('play-btn').disabled = !data.is_current_player;
                document.getElementById('pass-btn').disabled = !data.is_current_player;
                
                // Show winner if game ended
                if (data.winner) {
                    showWinnerScreen(data.winner, data.scores);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        function showWinnerScreen(winnerId, scores) {
            // Find winner name
            let winnerName = '';
            for (const [pid, player] of Object.entries(games[roomId].players)) {
                if (pid === winnerId) {
                    winnerName = player.name;
                    break;
                }
            }
            
            const winnerScreen = document.getElementById('winner-screen');
            const winnerMessage = document.getElementById('winner-message');
            const scoresDisplay = document.getElementById('scores-display');
            
            if (winnerId === playerId) {
                winnerMessage.textContent = `Congratulations ${winnerName}! You won!`;
            } else {
                winnerMessage.textContent = `${winnerName} has won the game!`;
            }
            
            // Display scores
            scoresDisplay.innerHTML = '<h3>Scores:</h3>';
            for (const [pid, score] of Object.entries(scores)) {
                const player = games[roomId].players[pid];
                scoresDisplay.innerHTML += `<p>${player.name}: ${score} cards remaining</p>`;
            }
            
            winnerScreen.style.display = 'flex';
        }
        
        function createCardElement(card, selectable) {
            const [rank, suit] = card;
            const cardElement = document.createElement('div');
            cardElement.className = `card ${suit}`;
            
            const rankElement = document.createElement('div');
            rankElement.className = 'rank';
            rankElement.textContent = rank;
            
            const suitElement = document.createElement('div');
            suitElement.className = 'suit';
            
            switch(suit) {
                case 'hearts': suitElement.textContent = '♥'; break;
                case 'diamonds': suitElement.textContent = '♦'; break;
                case 'clubs': suitElement.textContent = '♣'; break;
                case 'spades': suitElement.textContent = '♠'; break;
            }
            
            const rankBottomElement = document.createElement('div');
            rankBottomElement.className = 'rank bottom';
            rankBottomElement.textContent = rank;
            
            cardElement.appendChild(rankElement);
            cardElement.appendChild(suitElement);
            cardElement.appendChild(rankBottomElement);
            
            if (selectable) {
                cardElement.addEventListener('click', () => {
                    cardElement.classList.toggle('selected');
                    
                    const cardIndex = selectedCards.findIndex(c => 
                        c[0] === card[0] && c[1] === card[1]);
                    
                    if (cardIndex === -1) {
                        selectedCards.push(card);
                    } else {
                        selectedCards.splice(cardIndex, 1);
                    }
                });
            }
            
            return cardElement;
        }
        
        function playCards() {
            if (selectedCards.length === 0) {
                alert('Please select cards to play');
                return;
            }
            
            socket.emit('play_cards', {
                cards: selectedCards
            });
            
            selectedCards = [];
        }
        
        function passTurn() {
            socket.emit('pass_turn');
        }
    </script>
<ul id="player-list"></ul>  <!-- Shows player names -->

<!-- Add Socket.IO library -->
<!-- Load Socket.IO FIRST -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<!-- Then your custom JS -->
<script src="/static/script.js"></script> 
<script>
    
</script>
</body>
</html>
